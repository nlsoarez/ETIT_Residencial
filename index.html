<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta SLA - ETIT Residencial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* [Manter todos os estilos anteriores] */
    </style>
</head>
<body>
    <!-- [Manter toda a estrutura HTML anterior] -->

    <script>
        let dadosPlanilha = [];
        let fileName = "";
        let dadosFiltrados = { ganhos: [], perdas: [] };

        const loginToName = {
            "N0238475": "MARLEY MARQUES RIBEIRO",
            "N5923221": "KELLY PINHEIRO LIRA",
            "F160641": "JENNIFER MARIA ANDRADE SANTOS",
            "N5772086": "THIAGO PEREIRA DA SILVA",
            "N0239871": "LEONARDO FERREIRA LIMA DE ALMEIDA",
            "N5577565": "MARISTELLA MARCIA DOS SANTOS",
            "N5737414": "SANDRO DA SILVA CARVALHO",
            "N5972428": "CRISTIANE HERMOGENES DA SILVA",
            "N6173055": "JEFFERSON LUIS GONÇALVES COITINHO",
            "N5932090": "EVILÁZIO ANDRÉ DE MAGALHÃES GOMES PEREIRA",
            "N0255801": "ELBERTON ANICETO HENRIQUE",
            "N4014011": "ALAN MARINHO DIAS",
            "N5923996": "JULIO CESAR SANTOS SOARES"
        };

        document.getElementById('upload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            fileName = file.name;
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    dadosPlanilha = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    showMessage(`Planilha "${fileName}" carregada com sucesso!`, 'sucesso');
                } catch (error) {
                    showMessage("Erro ao processar o arquivo. Certifique-se de que é um arquivo Excel válido.", 'erro');
                    console.error(error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        });

        function consultarSLA() {
            const login = document.getElementById('login').value.trim().toUpperCase();
            
            if (!login) {
                showMessage("Digite um login para consultar!", 'erro');
                return;
            }
            
            if (dadosPlanilha.length === 0) {
                showMessage("Nenhuma planilha foi carregada ainda.", 'erro');
                return;
            }
            
            if (!loginToName[login]) {
                showMessage("Login não encontrado na base de dados.", 'erro');
                return;
            }

            let ganhos = [];
            let perdas = [];
            let totalTempoGanhos = 0;
            let totalTempoPerdas = 0;

            dadosPlanilha.forEach(row => {
                if (!row || row.length < 9) return;

                // Estrutura das colunas:
                // 0: Ticket
                // 1: Login
                // 4: Tempo (em dias)
                // 5: HFC - Volume (Coluna F)
                // 6: HFC - Indicador (Coluna G)
                // 7: GPON - Volume (Coluna H)
                // 8: GPON - Indicador (Coluna I)
                
                let ticket = row[0];
                let usuarioLogin = row[1]?.toString().trim().toUpperCase();
                let tempo = parseFloat(row[4]) * 1440; // Convertendo dias para minutos
                
                // HFC: Coluna F (Volume) e G (Indicador)
                let hfcVolume = row[5];
                let hfcIndicador = row[6];
                
                // GPON: Coluna H (Volume) e I (Indicador)
                let gponVolume = row[7];
                let gponIndicador = row[8];

                if (usuarioLogin === login) {
                    let tipo = '';
                    
                    // Verificar HFC (1 0 ou 1 1)
                    const isHFC = hfcVolume == 1 && (hfcIndicador == 0 || hfcIndicador == 1);
                    
                    // Verificar GPON (1 0 ou 1 1)
                    const isGPON = gponVolume == 1 && (gponIndicador == 0 || gponIndicador == 1);
                    
                    if (isHFC && isGPON) {
                        tipo = 'HFC + GPON';
                    } else if (isHFC) {
                        tipo = 'HFC';
                    } else if (isGPON) {
                        tipo = 'GPON';
                    } else {
                        tipo = 'Indefinido';
                    }

                    // Dentro do SLA (1 1)
                    if ((hfcVolume == 1 && hfcIndicador == 1) || (gponVolume == 1 && gponIndicador == 1)) {
                        ganhos.push([ticket, tempo.toFixed(2), tipo]);
                        totalTempoGanhos += tempo;
                    } 
                    // Fora do SLA (1 0)
                    else if ((hfcVolume == 1 && hfcIndicador == 0) || (gponVolume == 1 && gponIndicador == 0)) {
                        perdas.push([ticket, tempo.toFixed(2), tipo]);
                        totalTempoPerdas += tempo;
                    }
                }
            });

            // [Restante do código permanece igual...]
            dadosFiltrados = { ganhos, perdas };

            // Exibir resultados
            document.getElementById("nomeUsuario").textContent = `Consultor: ${loginToName[login]} (${login})`;
            
            document.getElementById("totalGanhos").textContent = ganhos.length;
            document.getElementById("totalPerdas").textContent = perdas.length;
            
            let mediaGanhos = ganhos.length > 0 ? (totalTempoGanhos / ganhos.length).toFixed(2) : "0.00";
            let mediaPerdas = perdas.length > 0 ? (totalTempoPerdas / perdas.length).toFixed(2) : "0.00";
            
            document.getElementById("mediaGanhos").textContent = mediaGanhos;
            document.getElementById("mediaPerdas").textContent = mediaPerdas;
            
            // Atualizar tabelas
            atualizarTabela("tabelaGanhos", ganhos, "ganho");
            atualizarTabela("tabelaPerdas", perdas, "perda");
            
            // Mostrar seções de resultados
            document.getElementById("contadores").style.display = "grid";
            document.getElementById("tabelaGanhos").style.display = ganhos.length > 0 ? "block" : "none";
            document.getElementById("tabelaPerdas").style.display = perdas.length > 0 ? "block" : "none";
            document.getElementById('filtros').style.display = (ganhos.length > 0 || perdas.length > 0) ? 'flex' : 'none';
            document.getElementById('btnExportar').style.display = (ganhos.length > 0 || perdas.length > 0) ? 'block' : 'none';
            
            // Exibir estatísticas por tecnologia
            exibirEstatisticasPorTecnologia(login);
            
            showMessage(`Consulta realizada para ${loginToName[login]}. ${ganhos.length} dentro do SLA e ${perdas.length} fora do SLA.`, 'sucesso');
        }

        function exibirEstatisticasPorTecnologia(login) {
            const stats = {
                HFC: { total: 0, tempoTotal: 0, dentroSLA: 0 },
                GPON: { total: 0, tempoTotal: 0, dentroSLA: 0 }
            };

            dadosPlanilha.forEach(row => {
                if (!row || row.length < 9) return;

                let usuarioLogin = row[1]?.toString().trim().toUpperCase();
                if (usuarioLogin !== login) return;

                let tempo = parseFloat(row[4]) * 1440;
                
                // HFC
                if (row[5] == 1) { // Volume HFC
                    stats.HFC.total++;
                    stats.HFC.tempoTotal += tempo;
                    if (row[6] == 1) stats.HFC.dentroSLA++; // Indicador HFC
                }
                
                // GPON
                if (row[7] == 1) { // Volume GPON
                    stats.GPON.total++;
                    stats.GPON.tempoTotal += tempo;
                    if (row[8] == 1) stats.GPON.dentroSLA++; // Indicador GPON
                }
            });

            // [Restante da função permanece igual...]
            document.getElementById("totalHFC").textContent = stats.HFC.total;
            document.getElementById("dentroHFC").textContent = stats.HFC.dentroSLA;
            document.getElementById("tempoHFC").textContent = stats.HFC.total > 0 ? (stats.HFC.tempoTotal / stats.HFC.total).toFixed(2) : "0.00";

            document.getElementById("totalGPON").textContent = stats.GPON.total;
            document.getElementById("dentroGPON").textContent = stats.GPON.dentroSLA;
            document.getElementById("tempoGPON").textContent = stats.GPON.total > 0 ? (stats.GPON.tempoTotal / stats.GPON.total).toFixed(2) : "0.00";

            document.getElementById("statsTecnologia").style.display = (stats.HFC.total > 0 || stats.GPON.total > 0) ? "grid" : "none";
        }

        // [Manter as demais funções inalteradas]
    </script>
</body>
</html>
